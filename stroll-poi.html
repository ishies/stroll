<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stroll App - Nearby POI</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Clarendon', 'Georgia', serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .phone-container {
            width: 320px;
            height: 600px;
            background: linear-gradient(180deg, #a8d5ba 0%, #6fb583 50%, #4a9b63 100%);
            border-radius: 30px;
            padding: 40px 25px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .back-arrow {
            position: absolute;
            top: 30px;
            left: 25px;
            width: 35px;
            height: 35px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            cursor: pointer;
            z-index: 10;
            transition: background 0.2s;
        }

        .back-arrow:hover {
            background: rgba(255,255,255,0.4);
        }

        .top-actions {
            position: absolute;
            top: 30px;
            right: 25px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .action-btn {
            width: 35px;
            height: 35px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: rgba(255,255,255,0.4);
            transform: scale(1.05);
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .heart-btn.liked {
            background: rgba(255,255,255,0.9);
            color: #e53e3e;
            animation: heartPulse 0.3s ease-in-out;
        }

        @keyframes heartPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .refresh-btn.spinning {
            animation: spin 0.6s ease-in-out;
        }

        .refresh-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .refresh-icon svg {
            width: 100%;
            height: 100%;
        }

        .content {
            position: relative;
            z-index: 5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 60px;
        }

        .map-container {
            width: 100%;
            height: 220px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            margin-bottom: 15px;
        }

        .map-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        h1 {
            color: white;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .poi-box {
            width: 100%;
            background: white;
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .poi-name {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 6px;
        }

        .poi-distance {
            font-size: 15px;
            color: #718096;
        }

        .button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-family: 'Clarendon', 'Georgia', serif;
            background: linear-gradient(135deg, #8b5a3c 0%, #a0745c 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(139,90,60,0.4);
        }

        .button:hover {
            box-shadow: 0 6px 20px rgba(139,90,60,0.5);
        }

        .button:active {
            transform: scale(0.98);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="back-arrow" onclick="window.history.back()">‚Äπ</div>
        
        <div class="top-actions">
            <button class="action-btn refresh-btn" id="refreshBtn" title="Refresh POI">
                <div class="refresh-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 12C4 7.58172 7.58172 4 12 4C14.5264 4 16.7792 5.17108 18.2454 7" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                        <path d="M20 12C20 16.4183 16.4183 20 12 20C9.47362 20 7.22082 18.8289 5.75463 17" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                        <path d="M17 7L18.5 7L18.5 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M7 17L5.5 17L5.5 18.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </button>
            <button class="action-btn heart-btn" id="heartBtn" title="Like this POI">
                ‚ô°
            </button>
        </div>
        
        <div class="content">
            <div class="map-container">
                <svg class="map-image" viewBox="0 0 270 280" xmlns="http://www.w3.org/2000/svg">
                    <rect width="270" height="280" fill="#e8f5e9"/>
                    <line x1="0" y1="140" x2="270" y2="140" stroke="#cbd5e0" stroke-width="8"/>
                    <line x1="135" y1="0" x2="135" y2="280" stroke="#cbd5e0" stroke-width="8"/>
                    <rect x="20" y="20" width="80" height="80" fill="#81c784" rx="8"/>
                    <rect x="170" y="170" width="80" height="80" fill="#81c784" rx="8"/>
                    <rect x="150" y="30" width="40" height="50" fill="#a0aec0" rx="4"/>
                    <rect x="200" y="40" width="35" height="60" fill="#a0aec0" rx="4"/>
                    <rect x="30" y="160" width="50" height="45" fill="#a0aec0" rx="4"/>
                    <rect x="90" y="175" width="30" height="55" fill="#a0aec0" rx="4"/>
                    <circle cx="135" cy="140" r="20" fill="#4a9b63" opacity="0.3"/>
                    <circle cx="135" cy="140" r="10" fill="#4a9b63"/>
                    <circle cx="135" cy="140" r="5" fill="white"/>
                    <g transform="translate(180, 90)">
                        <path d="M 0 -20 Q -8 -20, -8 -12 L -8 12 Q -8 20, 0 20 Q 8 20, 8 12 L 8 -12 Q 8 -20, 0 -20 Z" fill="#8b5a3c"/>
                        <circle cx="0" cy="25" r="3" fill="#8b5a3c"/>
                    </g>
                </svg>
            </div>
            
            <h1>Nearby POI</h1>
            
            <div class="poi-box">
                <div class="poi-name">Blue Bottle Coffee</div>
                <div class="poi-distance">450 W 15th St, New York, NY 10011</div>
            </div>
            
            <button class="button" id="detailsBtn">See Details</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, where, limit, doc, getDoc, setDoc, updateDoc, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCZlUYoU77T2cBHTxlQW6FWaMVX_0yZ5rc",
            authDomain: "stroll-c5285.firebaseapp.com",
            projectId: "stroll-c5285",
            storageBucket: "stroll-c5285.firebasestorage.app",
            messagingSenderId: "465458957302",
            appId: "1:465458957302:web:1b104b86069514164615d7",
            measurementId: "G-PZY4GX7SSE"
        };

        const mockPOIs = [
            { name: "Blue Bottle Coffee", address: "450 W 15th St, New York, NY 10011", type: "coffee_shop", amenity: "cafe" },
            { name: "Stumptown Coffee Roasters", address: "30 W 8th St, New York, NY 10011", type: "coffee_shop", amenity: "cafe" },
            { name: "The High Line", address: "New York, NY 10011", type: "park", amenity: "park" },
            { name: "Chelsea Market", address: "75 9th Ave, New York, NY 10011", type: "market", amenity: "marketplace" },
            { name: "Joe's Pizza", address: "7 Carmine St, New York, NY 10014", type: "restaurant", amenity: "restaurant" },
            { name: "Washington Square Park", address: "Washington Square, New York, NY 10012", type: "park", amenity: "park" },
            { name: "Strand Bookstore", address: "828 Broadway, New York, NY 10003", type: "bookstore", amenity: "bookstore" }
        ];

        let currentPOI = null;
        let isLiked = false;
        let userPreferences = {};
        let db = null;
        let auth = null;
        let shownPOIs = [];
        let currentUserUID = null;
        let app = null;
        let userDocId = null;

        function parseAmenities(raw) {
            if (!raw) return [];
            if (typeof raw === 'string') {
                const tupleRegex = /\(\s*([^,]+?)\s*,\s*(\d+)\s*\)/g;
                const matches = [];
                let match;
                while ((match = tupleRegex.exec(raw)) !== null) {
                    const amenity = match[1].trim();
                    const frequency = parseInt(match[2], 10);
                    matches.push({ amenity, frequency });
                    console.log(`  Parsed: ${amenity} = ${frequency} (type: ${typeof frequency})`);
                }
                if (matches.length > 0) return matches;
            }
            if (Array.isArray(raw)) {
                return raw.map(item => {
                    if (Array.isArray(item)) return { amenity: item[0], frequency: parseInt(item[1], 10) || 0 };
                    if (typeof item === 'object') {
                        const amen = item.amenity || item.name || item[0];
                        const freq = parseInt(item.frequency || item.freq || item.count || 1, 10);
                        return { amenity: amen, frequency: freq };
                    }
                    return { amenity: String(item), frequency: 1 };
                });
            }
            return [{ amenity: String(raw), frequency: 1 }];
        }

        function weightedPick(items) {
            const total = items.reduce((s, it) => s + (Number(it.frequency) || 0), 0);
            if (total <= 0) return items[Math.floor(Math.random() * items.length)];
            let r = Math.random() * total;
            for (const it of items) {
                r -= (Number(it.frequency) || 0);
                if (r <= 0) return it;
            }
            return items[items.length - 1];
        }

        async function loadPOIWithFirebase() {
            try {
                if (!currentUserUID) {
                    console.warn('No user UID available');
                    loadPOIMock();
                    return;
                }

                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('uid', '==', currentUserUID));
                const userQuerySnap = await getDocs(q);

                if (userQuerySnap.empty) {
                    console.warn('No user profile found for UID:', currentUserUID);
                    loadPOIMock();
                    return;
                }

                const userDoc = userQuerySnap.docs[0];
                userDocId = userDoc.id;
                const userData = userDoc.data();
                const cluster = userData.Cluster;
                
                console.log('‚úÖ Found user document ID:', userDocId);
                console.log('User cluster:', cluster);

                const rawPrefs = userData.preferences;
                let preferencesAlreadyExist = false;
                
                console.log('üìä Raw preferences from Firestore:', rawPrefs);
                console.log('üìä Type of preferences:', typeof rawPrefs, Array.isArray(rawPrefs) ? '(array)' : '');
                
                if (rawPrefs && typeof rawPrefs === 'object' && !Array.isArray(rawPrefs) && Object.keys(rawPrefs).length > 0) {
                    // User has existing preferences - load them
                    userPreferences = {};
                    for (const key in rawPrefs) {
                        const value = rawPrefs[key];
                        userPreferences[key] = typeof value === 'number' ? value : parseInt(value) || 0;
                    }
                    preferencesAlreadyExist = true;
                    console.log('‚úÖ Loaded existing user preferences:', userPreferences);
                } else {
                    // No preferences yet - will initialize after loading cluster
                    userPreferences = {};
                    console.log('‚ÑπÔ∏è No existing preferences found, will initialize from cluster');
                }

                const centroidsRef = collection(db, 'clusters');
                const centQ = query(centroidsRef, where('Cluster', '==', cluster), limit(1));
                const centSnap = await getDocs(centQ);

                if (centSnap.empty) {
                    console.warn('No centroid found');
                    loadPOIMock();
                    return;
                }

                const centroid = centSnap.docs[0].data();
                const rawAmenities = centroid.amenities || centroid.Amenities;
                console.log('üè∑Ô∏è Raw amenities from cluster:', rawAmenities);
                const amenities = parseAmenities(rawAmenities);
                console.log('‚úÖ Parsed amenities:', amenities);

                if (!amenities || amenities.length === 0) {
                    console.warn('No amenities in centroid');
                    loadPOIMock();
                    return;
                }

                // Only initialize if we didn't already load preferences from Firestore
                if (!preferencesAlreadyExist) {
                    console.log('üÜï Initializing preferences from cluster centroid');
                    amenities.forEach(a => {
                        // Ensure frequency is a number
                        const freq = parseInt(a.frequency, 10);
                        userPreferences[a.amenity] = freq;
                        console.log(`  Setting ${a.amenity} = ${freq} (type: ${typeof freq})`);
                    });
                    console.log('‚úÖ Initial preferences set from cluster:', userPreferences);
                    const saved = await savePreferencesToFirebase();
                    if (!saved) {
                        console.error('‚ùå Failed to save initial preferences!');
                    }
                } else {
                    console.log('‚úÖ Using existing preferences, skipping initialization');
                }

                // Get exploration rate from localStorage (slider value from nav page)
                const savedVariability = localStorage.getItem('strollVariability');
                const EXPLORATION_RATE = savedVariability ? parseInt(savedVariability) / 100 : 0.20;
                console.log('üé≤ Exploration rate:', (EXPLORATION_RATE * 100) + '%');
                
                let amenityChoice;
                
                if (Math.random() < EXPLORATION_RATE) {
                    const randomAmenity = amenities[Math.floor(Math.random() * amenities.length)];
                    amenityChoice = randomAmenity.amenity;
                    console.log('üîç EXPLORING:', amenityChoice);
                } else {
                    const weightedAmenities = amenities.map(a => ({
                        amenity: a.amenity,
                        frequency: userPreferences[a.amenity] || 1
                    }));
                    const picked = weightedPick(weightedAmenities);
                    amenityChoice = picked.amenity;
                    console.log('‚úÖ Using preference:', amenityChoice);
                }

                const poisRef = collection(db, 'pois');
                const poisQ = query(poisRef, where('amenity', '==', amenityChoice));
                const poisSnap = await getDocs(poisQ);

                if (poisSnap.empty) {
                    console.warn('No POIs found for', amenityChoice);
                    loadPOIMock();
                    return;
                }

                let availableDocs = poisSnap.docs.filter(d => !shownPOIs.includes(d.id));
                if (availableDocs.length === 0) {
                    shownPOIs = [];
                    availableDocs = poisSnap.docs;
                }

                const chosenDoc = availableDocs[Math.floor(Math.random() * availableDocs.length)];
                currentPOI = { ...chosenDoc.data(), _id: chosenDoc.id };
                shownPOIs.push(chosenDoc.id);
                if (shownPOIs.length > 10) shownPOIs.shift();

                updateUI();

            } catch (err) {
                console.error('Firebase error:', err);
                loadPOIMock();
            }
        }

        function loadPOIMock() {
            let availablePOIs = mockPOIs.filter(poi => !shownPOIs.includes(poi.name));
            if (availablePOIs.length === 0) {
                shownPOIs = [];
                availablePOIs = mockPOIs;
            }
            
            currentPOI = availablePOIs[Math.floor(Math.random() * availablePOIs.length)];
            shownPOIs.push(currentPOI.name);
            if (shownPOIs.length > 5) shownPOIs.shift();
            
            updateUI();
        }

        function updateUI() {
            document.querySelector('.poi-name').textContent = currentPOI.name || 'Recommended Place';
            document.querySelector('.poi-distance').textContent = currentPOI.address || '';
            
            isLiked = false;
            const heartBtn = document.getElementById('heartBtn');
            heartBtn.textContent = '‚ô°';
            heartBtn.classList.remove('liked');
        }

        async function savePreferencesToFirebase() {
            try {
                if (!currentUserUID || !db) {
                    console.warn('‚ö†Ô∏è Cannot save - missing UID or db');
                    return false;
                }
                
                console.log('üíæ Saving preferences for UID:', currentUserUID);
                console.log('üíæ Preferences:', userPreferences);
                
                if (!userDocId) {
                    console.log('üîç Querying for user document with uid:', currentUserUID);
                    const usersRef = collection(db, 'users');
                    const q = query(usersRef, where('uid', '==', currentUserUID));
                    const querySnapshot = await getDocs(q);
                    
                    console.log('üìä Query returned', querySnapshot.size, 'documents');
                    
                    if (querySnapshot.empty) {
                        console.error('‚ùå No user document found with uid:', currentUserUID);
                        console.error('‚ùå Make sure the user document has a uid field matching:', currentUserUID);
                        return false;
                    }
                    
                    userDocId = querySnapshot.docs[0].id;
                    console.log('‚úÖ‚úÖ Found user document ID:', userDocId);
                    console.log('üìÑ Document data:', querySnapshot.docs[0].data());
                }
                
                const userRef = doc(db, 'users', userDocId);
                
                await updateDoc(userRef, { 
                    preferences: userPreferences,
                    UpdatedAt: serverTimestamp()
                });
                
                console.log('‚úÖ‚úÖ‚úÖ Preferences saved successfully to document:', userDocId);
                return true;
            } catch (err) {
                console.error('‚ùå Error saving preferences:', err);
                console.error('Error code:', err.code);
                console.error('Error message:', err.message);
                return false;
            }
        }

        async function handleLike() {
            if (!currentPOI) return;

            const amenityType = currentPOI.amenity || currentPOI.type;
            
            if (!isLiked) {
                isLiked = true;
                userPreferences[amenityType] = (userPreferences[amenityType] || 0) + 1;
                console.log('‚ù§Ô∏è LIKED:', amenityType, '- New count:', userPreferences[amenityType]);
            } else {
                isLiked = false;
                if (userPreferences[amenityType] > 0) {
                    userPreferences[amenityType]--;
                    if (userPreferences[amenityType] === 0) {
                        delete userPreferences[amenityType];
                    }
                }
                console.log('üíî UNLIKED:', amenityType);
            }

            const heartBtn = document.getElementById('heartBtn');
            heartBtn.textContent = isLiked ? '‚ô•' : '‚ô°';
            heartBtn.classList.toggle('liked', isLiked);
            
            console.log('üìä Current preferences:', userPreferences);
            
            await savePreferencesToFirebase();
        }

        function handleRefresh() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('spinning');
            setTimeout(() => refreshBtn.classList.remove('spinning'), 600);
            
            if (currentUserUID && db) {
                loadPOIWithFirebase();
            } else {
                loadPOIMock();
            }
        }

        async function init() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                console.log('‚úÖ Firebase initialized');

                onAuthStateChanged(auth, (user) => {
                    if (!user) {
                        console.error('‚ùå No user authenticated');
                        window.location.href = 'stroll-signin.html';
                        return;
                    }

                    currentUserUID = user.uid;
                    console.log('‚úÖ User authenticated:', currentUserUID);
                    loadPOIWithFirebase();
                });
            } catch (err) {
                console.error('‚ùå Firebase error:', err);
                loadPOIMock();
            }
        }

        window.addEventListener('load', () => {
            init();
            
            document.getElementById('heartBtn').addEventListener('click', handleLike);
            document.getElementById('refreshBtn').addEventListener('click', handleRefresh);
            
            document.getElementById('detailsBtn').addEventListener('click', () => {
                if (currentPOI) {
                    console.log('üîç Current POI data:', currentPOI);
                    
                    const name = currentPOI.name || '';
                    const address = currentPOI.address || '';
                    const x = currentPOI.X || currentPOI.x || currentPOI.longitude || currentPOI.lon;
                    const y = currentPOI.Y || currentPOI.y || currentPOI.latitude || currentPOI.lat;
                    
                    console.log('üìç Extracted - Name:', name, 'Address:', address, 'X:', x, 'Y:', y);
                    
                    let mapsUrl;
                    
                    // Priority: Use name + address for search, coordinates as backup for precision
                    if (name) {
                        // Search by name, optionally with address for context
                        const searchQuery = address ? `${name}, ${address}` : name;
                        
                        // If we have coordinates, add them to help Google narrow down results
                        if (x !== undefined && y !== undefined && !isNaN(parseFloat(x)) && !isNaN(parseFloat(y))) {
                            const lat = parseFloat(y);
                            const lon = parseFloat(x);
                            // This searches for the name and centers map near coordinates
                            mapsUrl = `https://www.google.com/maps/search/${encodeURIComponent(searchQuery)}/@${lat},${lon},15z`;
                            console.log('‚úÖ Opening Maps with name search:', searchQuery, 'near', lat, lon);
                        } else {
                            // Just search by name/address without coordinates
                            mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(searchQuery)}`;
                            console.log('‚úÖ Opening Maps with name search:', searchQuery);
                        }
                    } else if (x !== undefined && y !== undefined && !isNaN(parseFloat(x)) && !isNaN(parseFloat(y))) {
                        // Fallback: Only coordinates, no name
                        const lat = parseFloat(y);
                        const lon = parseFloat(x);
                        mapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
                        console.log('‚ö†Ô∏è No name found, using coordinates:', lat, lon);
                    } else {
                        // Last resort: Just address
                        mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address || 'location')}`;
                        console.log('‚ö†Ô∏è Using address fallback:', address);
                    }
                    
                    window.open(mapsUrl, '_blank');
                }
            });
        });
    </script>
</body>
</html>
